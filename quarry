-- Dar Quarry by Darganis
-- version: 0.0.2 9/3/2012

local m = dagsAPI.Move.new()
local a = dagsAPI.Action.new()
local u = dagsAPI.Utils.new()

local params = { ... }

if #params == 1 then

  length  = tonumber(params[1])

else

  term.clear()
  term.setCursorPos(1,1)
  term.write("Radius of quarry? ")
  length = tonumber(read())

end

-- set the width to length
width = length
-- Coordinates
xcord = 0
ycord = 0
zcord = 0
-- Direction
dir = 1

print("")

function refuel()
  if turtle.getFuelLevel() < 5 then
    print("Refueling...")
    shell.run("refuel", 5)
  end
end

function pillar()
  local output = true
  output1 = a.digFront()
  goForward(1)
  output2 = a.digDown()
  output3 = a.digUp()
  return ( output1 and output2 and output3 )
end

function row(width)
  local curWidth = 0
  while curWidth < width do
    output = pillar()
    curWidth = curWidth + 1
  end
  return output, curWidth
end

function level()
  local side
  local output1 = false
  local output2 = false
  local curLength = 0
  local curWidth = 0
  -- repeat levels till can move down
  for i=1,length do
    side = (i%2)*2
    print(side)
    if i == 1 then
      turnToDir(2)
      output2, curWidth = row(width-1)
    else
      turnToDir(1)
      output1 = pillar()
      turnToDir(side)
      output2, curWidth = row(width-1)
    end
    curLength = curLength + 1
  end
  levelReturnToStart(curLength,curWidth)
end

function goNextLevel()
  a.digDown()
  output = goDown(1)
  a.digDown()
  output = goDown(1)
  a.digDown()
  return output
end

function levelReturnToStart( length, width )
  if xcord == 0 then
    turnToDir(3)
  else
    turnToDir(4)
    goForward(width-1)
    turnToDir(3)
  end
  goForward(length-1)
end

function quarry()
  refuel()
  if turtle.getFuelLevel() == 0 then
    print("I am out of fuel. Please give me fuel and try again.")
    return
  end
  a.digFront()
  goForward(1)
  goNextLevel()
  repeat
    level()
  until not goNextLevel()
end

-- Utility Functions

function goForward( times )
  local succeed, count = m.forward(times)
  if dir == 1 then
    zcord = zcord + count
  elseif dir == 2 then
    xcord = xcord + count
  elseif dir == 3 then
    zcord = zcord - count
  elseif dir == 4 then
    xcord = xcord - count
  end
  printStats()
  return succeed
end

function goDown( times )
  local succeed, count = m.down(times)
  ycord = ycord - count
  printStats()
  return succeed
end

function goUp( times )
  local succeed, count = m.up(times)
  ycord = ycord + count
  printStats()
  return succeed
end

function turnToDir( side )
  local compare = math.abs(dir - side)
  local turnTo = "right"
  if compare == 3 then
    if dir < side then
      turnTo = "left"
    end
    m.turn(turnTo, 1)
  else
    m.turn(turnTo, compare)
  end
  dir = side
  printStats()
end

function printStats()
  term.clear()
  term.setCursorPos(1,1)
  print("xcord = "..xcord)
  print("ycord = "..ycord)
  print("zcord = "..zcord)
  print("dir = "..dir)
end

-- pause to close screen
sleep(2)
quarry()